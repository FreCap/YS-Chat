<html>
<p id="text">socket.io</p>
<head>
<script src="socket.io-6.0.js"></script> 
<script src="jquery-1.5.1.min.js"></script>
<script src="md5.js"></script>
<link type="text/css" rel="stylesheet" href="style.css" /> 

</head>

<input id="loginMethod" name="loginMethod" value="3" />
<input id="profilo_id" name="profilo_id" value="1" />
<input id="chat_key" name="chat_key" value="98jdas" />

<div class="bottomBarContainer">

	<div class="sideLeft profiliList">
	</div>
	
	<div class="OpenedChatWrapper">
		<div class="second">
			<div class="ChatTab opened">
				<div class="ButtonOpen">
				asd
				</div>
				<div class="TabOpened">
					<div class="Header">
					header
					</div>
					<div class="Body">
					body
					</div>
					<div class="Footer">
					footer
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script> 
    $(document).ready(function(){
		
		var Chat = function(start){
			var this2 = this;
		
			var statuses = { 
						DISCONNECTED: 0,
						CONNECTING: 1,
						CONNECTED: 2
					};// TODO da aggiungerne
		
			var actions = { CONNECT : 1, // { op:1 }
						LOGIN : 2, // { op:2, user:"String", pass:"String" }
						LOGINCHATKEY : 3, // { op:3, profilo_id:int, chat_key:"String" }
						CHG_STATUS : 4, // { op:4, status:int }
						DISCONNECT : 5, // { op:5 }
						CHAT_WITH : 6, // { op:6, profilo_id:int, message:"String" }
						CHAT_OPEN : 7, // { op:7, profilo_id:int }
						CHAT_CLOSE : 8, //  { op:8, profilo_id:int }
						LIST : 9 // { op:9 }
					}; 
			
			this.friends_online = [];
			this.status = 0;
			
			this.get_loginInfo = function(){
					var loginMethod = $("#loginMethod").val();
					var parametro;
					if (loginMethod == actions.LOGINCHATKEY){
						parametro = { 
								op: actions.LOGINCHATKEY,
								profilo_id: Math.floor(Math.random()*7),//TODO $("#profilo_id").val(),
								chat_key: $("#chat_key").val()
							}			
					}else{
						parametro = { 
								op: actions.LOGIN
								/* TODO, ricordarsi che si logga con l'account poi si deve scegliere il profilo */
							}	
					}
					return parametro;
				},
			
			this.server = {
				Login: function(){
					message = { op: actions.CONNECT };
					this2.sendSocket(message);
				},
				List: function(){
					var parametro = {
									op:actions.LIST
							}
					this2.sendSocket(parametro);
				}
			}
			
			this.GUI = {
				profilo_link_model: jQuery('<a/>').addClass('clearfix profilo').attr('href','#').append(jQuery('<a/>')),
				profilo_model: function(profilo_id,nickname){
					var profilo_link_model = this2.GUI.profilo_link_model.clone();
					profilo_link_model.attr("profilo_id", profilo_id);
					profilo_link_model.find("a").text(nickname);
					return profilo_link_model;
				},
				update_List: function(){
					$(".profiliList").empty();
					$.each(this2.friends_online, function(i, l){
						this2.GUI.profilo_model(l.profilo_id, l.nickname).appendTo($(".profiliList"));
					});
				}
			};
			
			
			this.socket = new io.Socket("localhost", {
			  port: 9999,
			  transports: ['websocket','flashsocket', 'xhr-polling'],
			  rememberTransport: false
			});
			
			this.start = function(){
				this2.socket.connect();
			}
		
			// Add a connect listener
			this.socket.on('connect',function() {
			  console.log('Connesso!');
			  this2.server.Login();
			});

			this.socket.on('message',function(data) {
				console.log('<< RECEIVING: ' + data);
				
				var data_JSON = $.parseJSON(data);
				switch (data_JSON.op) { 
					case actions.CONNECT: 
						if(this2.status == statuses.DISCONNECTED){
							this2.status = statuses.CONNECTING;
							var message = this2.get_loginInfo();
							var salt = data_JSON.salt;
							if (message.op == actions.LOGINCHATKEY){
								// cripta la chat_key
								message.chat_key = MD5(message.chat_key+""+salt);						
							}else if(message.op == actions.LOGIN){
								//TODO
							}
							this2.sendSocket(message);
						}
						break; 
					case actions.LOGIN: 
					case actions.LOGINCHATKEY: 
						if(data_JSON.result == true){
							this2.status = statuses.CONNECTED;
							this2.server.List();//TODO
							//fetch friends list
						}else{
							//TODO vari casi di errore, implementazione server mancante
						}
						break;
					case actions.LIST:
						this2.friends_online = data_JSON.list;
						this2.GUI.update_List();
						break;
				}
			});
			// Add a disconnect listener
			this.socket.on('disconnect',function() {
			  console.log('The client has disconnected!');
			  this2.status = statuses.DISCONNECTED;
			});

			this.sendSocket = function(message){
				console.log(">> SENDING:" + JSON.stringify(message));
				this2.socket.send(JSON.stringify(message));
			}
			
			if(start == true){
				this.start();
			}
			
		}
	
		var a = new Chat(true);
		
	});
</script> 
