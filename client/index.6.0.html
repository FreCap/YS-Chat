<html>
<p id="text">socket.io</p>
<head>
<script src="socket.io-6.0.js"></script> 
<script src="jquery-1.5.1.min.js"></script>
<script src="jquery.livequery.js"></script>
<script src="md5.js"></script>
<link type="text/css" rel="stylesheet" href="style.css" /> 

</head>

<input id="loginMethod" name="loginMethod" value="3" />
<input id="profilo_id" name="profilo_id" value="1" />
<input id="chat_key" name="chat_key" value="98jdas" />

<div class="bottomBarContainer">

	<div class="sideLeft profiliList">
	</div>
	
	<div class="OpenedChatWrapper">
			<div class="second">
			</div>
		</div>
	
	<div style="display:none" id="itemChat">
		<div class="ChatTab" id=""><!-- nell'id si mette l'id dell'account -->
			<div class="ButtonOpen">
				<div class="nickname"></div>
				<div class="status"></div><!-- TODO -->
			</div>
			<div class="TabOpened">
				<div class="Header">
					<div class="nickname"></div>
					<div class="status"></div><!-- TODO -->
					<div class="close">X</div><!-- TODO -->
				</div>
				<div class="Body">
				body
				</div>
				<div class="Footer">
					<input id="Input"/>
				</div>
			</div>
		</div>
	</div>
</div>

<script> 
    $(document).ready(function(){
		
		var Chat = function(start){
			var this2 = this;
		
			var statuses = { 
						DISCONNECTED: 0,
						CONNECTING: 1,
						CONNECTED: 2
					};// TODO da aggiungerne
		
			var actions = { CONNECT : 1, // { op:1 }
						LOGIN : 2, // { op:2, user:"String", pass:"String" }
						LOGINCHATKEY : 3, // { op:3, profilo_id:int, chat_key:"String" }
						CHG_STATUS : 4, // { op:4, status:int }
						DISCONNECT : 5, // { op:5 }
						CHAT_WITH : 6, // { op:6, profilo_id:int, message:"String" }
						CHAT_OPEN : 7, // { op:7, profilo_id:int }
						CHAT_CLOSE : 8, //  { op:8, profilo_id:int }
						CHAT_NOACTIVE : 9, // { op:9 }
						CLIENT_STATUS : 10, // { op:10, status:0(IDLED)|1(ONLINE) ( int }
						LIST : 11 // { op:11 }
					}; 
			
			this.friends_online = [];
			this.chatTab_opened = [];
			this.chatTab_active = null;
			this.status = 0;
			
			this.get_loginInfo = function(){
					var loginMethod = $("#loginMethod").val();
					var parametro;
					if (loginMethod == actions.LOGINCHATKEY){
						//DEBUG
						$("#profilo_id").val((Math.floor(Math.random()*6)+1));
						document.title = $("#profilo_id").val();
						
						parametro = { 
								op: actions.LOGINCHATKEY,
								profilo_id: parseInt($("#profilo_id").val()),
								chat_key: $("#chat_key").val()								
							}			
					}else{
						parametro = { 
								op: actions.LOGIN
								/* TODO, ricordarsi che si logga con l'account poi si deve scegliere il profilo */
							}	
					}
					return parametro;
				},
			
			this.server = {
				Login: function(){
					message = { op: actions.CONNECT };
					this2.sendSocket(message);
				},
				List: function(){
					var parametro = {
									op: actions.LIST
								}
					this2.sendSocket(parametro);
				},
				Chat_open: function(profilo_id_open){
					var parametro = {
									op: actions.CHAT_OPEN,
									profilo_id: parseInt(profilo_id_open)
								}
					this2.sendSocket(parametro);
				},
				Chat_close: function(profilo_id_close){
					var parametro = {
									op: actions.CHAT_CLOSE,
									profilo_id: parseInt(profilo_id_close)
								}
					this2.sendSocket(parametro);
				},
				Chat_noActive: function(){
					var parametro = {
									op: actions.CHAT_NOACTIVE,
								}
					this2.sendSocket(parametro);
				},
				Chat_with: function(profilo_idSend, messageSend){
					var parametro = {
									op: actions.CHAT_WITH,
									profilo_id: parseInt(profilo_idSend),
									message: messageSend
								}
					this2.sendSocket(parametro);
				}
				
			}
			
			this.GUI = {
				chat_opened_container: $(".OpenedChatWrapper").find(".second"),
				profilo_link_model: jQuery('<a/>').addClass('clearfix profilo').attr('href','#').append(jQuery('<a/>')),
				profilo_model: function(profilo_id,nickname){
					var profilo_link_model = this2.GUI.profilo_link_model.clone();
					profilo_link_model.attr("profilo_id", profilo_id);
					profilo_link_model.find("a").text(nickname);
					return profilo_link_model;
				},
				update_List: function(){
					$(".profiliList").empty();
					$.each(this2.friends_online, function(i, l){
						this2.GUI.profilo_model(l.profilo_id, l.nickname).appendTo($(".profiliList"));
					});
					
					//TODO to remove, debug
					this2.GUI.initEvents();
				},
				initEvents: function(){
					$(".profiliList").find(".profilo").livequery("click", function(e){
						this2.GUI.chatTab_Manager.open($(this).attr("profilo_id"));
					});
				},
				chatTab_Manager:{
					open: function(profilo_id, server){
						this2.GUI.chatTab_Manager.create(profilo_id);
						this2.GUI.chat_opened_container.find(".ChatTab.opened").removeClass("opened");
						this2.GUI.chat_opened_container.find(".ChatTab#" + profilo_id).addClass("opened");
						if(server != true){
							this2.server.Chat_open(profilo_id);
						}
					},
					create: function(profilo_id, server){
						var already_opened = false;
						$.each(this2.chatTab_opened, function(i, l){
							if(l == profilo_id){
								already_opened = true;
							}
						});
						if(!already_opened){
							var Chat_tab = $("#itemChat").find(".ChatTab").clone();
							var profilo;
							//TODO puramente per test, in realtà nell'originale è da usare il datamanager
							$.each(this2.friends_online, function(i, l){
								if(profilo_id == l.profilo_id){
									profilo = l;
								}
							});
							//fine TOD
							Chat_tab.attr("id",profilo.profilo_id);
							Chat_tab.find(".nickname").text(profilo.nickname);
							this2.chatTab_opened.push(profilo_id);
							this2.chatTab_active = profilo_id;
							this2.GUI.chat_opened_container.append(Chat_tab);
							this2.GUI.chatTab_Manager.initEvents(Chat_tab);
						}
					},
					close: function(profilo_id, server){
						$.each(this2.chatTab_opened, function(i, l){
							if(l == profilo_id){
								this2.chatTab_opened.splice(i,1);
							}
						});
						this2.GUI.chat_opened_container.find(".ChatTab#" + profilo_id).remove();
						if(server != true){
							this2.server.Chat_close(profilo_id);
						}
						
					},
					reduce: function(profilo_id, server){
						this2.chatTab_active = null;
						this2.GUI.chat_opened_container.find(".ChatTab#" + profilo_id).removeClass("opened");
						if(server != true){
							this2.server.Chat_noActive();
						}
					},
					initEvents: function(tab){
						tab = this2.GUI.chat_opened_container.find(".ChatTab#"+tab.attr("id"));
						tab.find(".ButtonOpen").livequery("click", function(e){
							this2.GUI.chatTab_Manager.open(tab.attr("id"));
						});
						tab.find(".close").livequery("click", function(e){
							this2.GUI.chatTab_Manager.close(tab.attr("id"));
							e.stopPropagation();
						});
						tab.find(".Header").livequery("click", function(e){
							this2.GUI.chatTab_Manager.reduce(tab.attr("id"));
						});
						
						tab.find("#Input").livequery("change", function(e){
							this2.server.Chat_with(tab.attr("id"), $(this).val());
							tab.val("");
						});
					}
				}
			};
			
			
			this.socket = new io.Socket("localhost", {
			  port: 9999,
			  transports: ['websocket','flashsocket', 'xhr-polling'],
			  rememberTransport: false
			});
			
			this.start = function(){
				this2.socket.connect();
			}
		
			// Add a connect listener
			this.socket.on('connect',function() {
			  console.log('Connesso!');
			  this2.server.Login();
			});

			this.socket.on('message',function(data) {
				console.log('<< RECEIVING: ' + data);
				
				var data_JSON = $.parseJSON(data);
				switch (data_JSON.op) { 
					case actions.CONNECT: 
						if(this2.status == statuses.DISCONNECTED){
							this2.status = statuses.CONNECTING;
							var message = this2.get_loginInfo();
							var salt = data_JSON.salt;
							if (message.op == actions.LOGINCHATKEY){
								// cripta la chat_key
								message.chat_key = MD5(message.chat_key+""+salt);						
							}else if(message.op == actions.LOGIN){
								//TODO
							}
							this2.sendSocket(message);
						}
						break; 
					case actions.LOGIN: 
					case actions.LOGINCHATKEY: 
						if(data_JSON.result == true){
							this2.status = statuses.CONNECTED;
							this2.server.List();//TODO
							//fetch friends list
						}else{
							//TODO vari casi di errore, implementazione server mancante
						}
						break;
					case actions.CHG_STATUS:
						break;
					case actions.DISCONNECT:
						break;
					case actions.CHAT_WITH:
						break;
					case actions.CHAT_OPEN:						
						$.each(data_JSON.chatTab, function(i, l){
							this2.GUI.chatTab_Manager.create(l.profilo_id, true);
						});
						this2.GUI.chatTab_Manager.open(data_JSON.chatTab_active, true);
						break;
					case actions.CHAT_CLOSE:
						this2.GUI.chatTab_Manager.close(data_JSON.profilo_id, true);
						break;
					case actions.CHAT_NOACTIVE:
						break;
					case actions.LIST:
						this2.friends_online = data_JSON.list;
						this2.GUI.update_List();
						break;
				}
			});
			// Add a disconnect listener
			this.socket.on('disconnect',function() {
			  console.log('The client has disconnected!');
			  this2.status = statuses.DISCONNECTED;
			});

			this.sendSocket = function(message){
				console.log(">> SENDING:" + JSON.stringify(message));
				this2.socket.send(JSON.stringify(message));
			}
			
			if(start == true){
				this.start();
			}
			
		}
	
		test = new Chat(true);
		
	});
	var test;
</script> 
